# Synthetic Workflow Test Plan

## Objectives

- Generate a deterministic synthetic market spanning 50 years of daily prices.
- Exercise tradeable data preparation, universe management, portfolio construction, and backtesting end to end.
- Inject data quality edge cases (missing rows, zero/negative prices, sparse histories) to verify diagnostic flags and filtering logic.

## Asset Taxonomy

| Sleeve | Count | Region | Category | Volatility Profile |
|--------|-------|--------|----------|--------------------|
| High-variance equities | 10 | world | stocks | Drift 7%, vol 25% |
| Investment-grade bonds | 10 | us | bonds | Drift 3%, vol 7% |
| REITs | 10 | world | reits | Drift 5%, vol 18% |
| Alternatives (commodities, gold, crypto proxy) | 10 | world | commodities | Drift 4%, vol 30% |

All tickers follow the convention `SYN_<CLASS>_<idx>.US` with broker symbols `SYN-<CLASS>-<idx>:US` for straightforward matching.

## Error Injection Matrix

| Ticker Pattern | Scenario | Expected Diagnostic |
|----------------|----------|---------------------|
| `*_MISSING` | Missing price file | `data_status=missing_file` |
| `*_SPARSE` | Fewer than 30 rows | `data_status=sparse` |
| `*_ZEROVOL` | Zero volume on 60% of rows | `data_status=warning`, `zero_volume_severity=high` |
| `*_NEGPRICE` | One negative close | `data_status=warning`, `non_positive_close` flag |
| `*_GAPPED` | 20-day NaN segment | Forward-fill test in returns pipeline |
| `*_LATESTART` | History begins 2010 | Selection should drop when `min_history_days`=500 |

The generator assigns scenarios to a subset of tickers per asset class; the remaining assets contain clean data with minor random gaps.

## Directory Layout

Synthetic fixtures live under `tests/fixtures/synthetic_workflow/`:

```
synthetic_workflow/
├── stooq/                    # Stooq-style tree with daily CSV files
│   └── daily/world/stocks/... # Generated by helper
├── tradeable_instruments/    # Broker CSVs (mbank.csv, boss.csv)
├── config/universes.yaml     # Two synthetic universes (core_equity, multi_asset)
└── README.md                 # Regeneration instructions
```

Utilities in `tests/synthetic_data.py` generate the tree on demand given a target directory to keep repository size small.

## Test Coverage Plan

1. **Data Preparation (`test_synthetic_data_preparation`)**

   - Run `scripts.prepare_tradeable_data` against generated fixtures.
   - Assert match report counts, data status distributions, and that sparse/invalid tickers route to unmatched list.
   - Verify exported price CSVs exist for valid tickers only.

1. **Universe Loading (`test_synthetic_universe_manager`)**

   - Build `UniverseManager` on synthetic reports.
   - Validate filter behaviour (e.g., `LATESTART` excluded when `min_history_days=500`).
   - Check classification outputs for each asset class.

1. **Return Pipeline (`test_synthetic_returns_workflow`)**

   - Load selected assets, run `ReturnCalculator.load_and_prepare`.
   - Ensure interpolation handles gapped series, warnings recorded in `ReturnSummary`.

1. **Portfolio Construction (`test_synthetic_portfolio_strategies`)**

   - Generate returns matrix and run `PortfolioConstructor.construct` for all strategies (`equal_weight`, `mean_variance`, `risk_parity` if dependency available).
   - Verify weight constraints, zero-sum checks, and presence of diversification across sleeves.

1. **Backtesting (`test_synthetic_backtesting_strategies`)**

   - Initialize `BacktestEngine` for each strategy using the synthetic price matrix.
   - Ensure each run produces an equity curve, metrics, and at least one rebalance.
   - Check transaction cost model integration with non-zero slippage.

1. **End-to-End CLI smoke (`test_synthetic_full_workflow_cli`)**

   - Invoke `scripts.construct_portfolio` and `scripts.calculate_returns` using exported synthetic products to mirror user workflow.
   - Ensure CLI exits 0 and outputs expected CSV artifacts.

## Next Steps

- Implement deterministic data generator (`tests/synthetic_data.py`).
- Author fixtures/universe config referencing generator outputs.
- Add integration tests executing the plan above, marking slow/RiskParity tests appropriately.
- Update documentation (this plan) and Memory Bank progress once tests are in place.

## Status (2025-10-19)

- ✅ `tests/synthetic_data.py` now produces deterministic Stooq-style fixtures with injected data-quality scenarios.
- ✅ New integration suite (`tests/integration/test_synthetic_workflow.py`) exercises data preparation, universe management, return calculation, portfolio construction, backtesting, and CLI workflows.
- ✅ CLI smoke coverage added for `scripts.calculate_returns` and `scripts.construct_portfolio`.
- ✅ Strategy validation includes both success (with explicit multivariate-normal returns) and failure (insufficient history) paths for optional dependencies (`PyPortfolioOpt`, `riskparityportfolio`).
- ⚠️ Mean-variance strategies may skip when PyPortfolioOpt is unavailable or optimisation fails on intentionally noisy data; the test records graceful degradation.
