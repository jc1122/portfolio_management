# Return Calculation Script: `calculate_returns.py`

## Overview

This script is the fourth step in the portfolio management toolkit's data pipeline and the first to perform significant financial calculations. Its purpose is to take the curated list of assets and their corresponding price histories, and transform them into a clean, aligned matrix of historical returns.

This returns matrix is the foundational data product upon which all subsequent quantitative analysis, portfolio construction, and backtesting are built.

Like the other scripts, this file acts as a command-line **orchestrator** for the core logic encapsulated in the `ReturnCalculator` class.

## Inputs (Prerequisites)

This script requires two primary data inputs generated by previous steps in the workflow. These inputs are **not redundant**; they serve distinct and complementary purposes.

1. **Classified Assets CSV (Required)**

   - **Generated by**: `scripts/classify_assets.py`
   - **Specified via**: `--assets`
   - **Purpose**: This file acts as the **"what to process" list**. It contains one row for each asset to be included in the calculation. Think of it as the ingredient list for a recipe.

1. **Cleaned Prices Directory (Required)**

   - **Generated by**: `scripts/prepare_tradeable_data.py`
   - **Specified via**: `--prices-dir`
   - **Purpose**: This directory is the **"source of the data"**. It contains the individual CSV files of historical price data for every available asset. Think of it as the pantry where you find the actual ingredients.

The script uses the assets file to know *which* price files to read from the prices directory to perform its calculations.

## The Calculation Pipeline in Detail

The process of creating the final returns matrix happens in several stages:

### Stage 1: Individual Return Calculation

For each asset in your list, the script first calculates its own historical returns. This happens in two sub-steps:

1. **Initial Calculation (Daily):** The script always starts by calculating **daily** returns from the `Close` price column. It uses the specific financial method you chose with the `--method` flag:

   - `simple`: Calculates `(price_today / price_yesterday) - 1`.
   - `log`: Calculates `ln(price_today / price_yesterday)`.
   - `excess`: First calculates the simple return, then subtracts the daily risk-free rate (which is converted from the annual rate you provide).

1. **Resampling to Target Frequency:** If you requested a frequency other than `daily` (e.g., `--frequency weekly`), the script **compounds** the daily returns over the target period.

   - For `simple` and `excess` returns, it does this by geometrically linking them (multiplying `1 + daily_return` for each day in the period).
   - For `log` returns, it simply sums the daily log returns over the period.

The result of this stage is a collection of individual return series, one for each asset.

### Stage 2: Alignment and Combination

This is a critical step where the individual return series, which may have different start dates, end dates, and missing days, are combined into a single, unified table (a pandas DataFrame). The `--align-method` flag controls how this is done:

- **`--align-method 'outer'` (Default):** This method creates a master date index that includes **all dates** present in **any** of the asset files. When an asset doesn't have a return for a specific date in the master index, its value is filled with `NaN` (Not a Number). This preserves all data but can create gaps that need to be handled by the `--handle-missing` strategy.

- \*\*`--align-method 'inner'`: \*\* This method creates a date index containing only the dates that are common to **every single asset**. This results in a clean, dense matrix with no missing values, but at the cost of potentially discarding large amounts of data if assets have different trading histories.

After alignment, the chosen `--handle-missing` strategy is applied, and finally, any asset not meeting the `--min-coverage` requirement is dropped.

### Stage 3: Final Matrix Structure

The final product is a CSV file with a clean, "wide" format that is ideal for analysis.

- **Index**: The first column of the file is the `Date`.
- **Columns**: Each subsequent column is named after an asset's ticker (e.g., `AAPL.US`, `MSFT.US`, `CDR.PL`).
- **Values**: The cells within the table are the calculated returns for that asset on that specific date.

**Example Structure (`returns.csv`):**

| Date       |   AAPL.US |   MSFT.US |   CDR.PL |
|:-----------|----------:|----------:|---------:|
| 2023-01-02 |    0.0123 |    0.0081 |  -0.015  |
| 2023-01-03 |   -0.0054 |    0.0112 |   0.0025 |
| ...        |       ... |       ... |      ... |

## Script Products

1. **Returns Matrix CSV (Primary Product)**

   - **Location**: The path specified by the `--output` argument.
   - **Description**: The main product is a single CSV file where rows are dates and columns are asset tickers. The values are the calculated returns. This file is the direct input for the `construct_portfolio.py` script.

1. **Console Summary**

   - **Activated by**: The `--summary` flag.
   - **Description**: When specified, the script prints a detailed statistical report to the console containing:
     - **Overall Statistics**: The date range of the returns and the total number of assets in the final matrix.
     - **Top/Bottom Performers**: Tables showing the assets with the highest and lowest annualized mean returns.
     - **Volatility**: A table of the annualized volatility (standard deviation) for each asset.
     - **Data Coverage**: The percentage of non-missing data points for each asset across the time period.
     - **Correlation Matrix**: If the number of assets is small enough (\<=5 by default), it prints a matrix of the pairwise correlations between assets.

## Features in Detail

### Return Calculation Method

The script can calculate returns using several standard financial methods, controlled by the `--method` argument. The options are `simple` (default), `log` (logarithmic), or `excess` (which subtracts the `--risk-free-rate`).

### Resampling Frequency

While the source data is daily, you can easily calculate returns over different periods. The `--frequency` argument allows you to choose `daily` (default), `weekly`, or `monthly` returns.

### Missing Data Strategy

This feature handles gaps in the **final, aligned returns matrix**, not gaps in the initial price data. The process happens *after* individual returns are calculated and aligned.

When multiple assets are combined into a single table (Stage 2), `NaN` (Not a Number) values are introduced on dates where one asset has a return but another does not. The `--handle-missing` argument tells the script how to resolve these `NaN` values:

- `forward_fill` (default): Fills `NaN` values by carrying the last valid return forward for a maximum of `--max-forward-fill` days.
- `interpolate`: Fills `NaN` values by drawing a straight line between the two nearest valid returns, up to the `--max-forward-fill` limit.
- `drop`: This is a more aggressive strategy that removes any date (row) where at least one asset has a `NaN` value. It is generally not recommended unless you use an `inner` alignment.

### Date Alignment

When combining assets that trade on different calendars or have different history lengths, you need to align them to a common date index. The `--align-method` flag controls this. Using `outer` (default) keeps all dates from all assets, creating a comprehensive but potentially sparse matrix. Using `inner` keeps only the dates where all assets have data, resulting in a smaller, denser matrix.

### Data Coverage Filtering

To ensure data quality, you can filter out assets that have too much missing data. The `--min-coverage` argument (default: 0.8) sets a threshold. Any asset with a lower proportion of actual data points over the period will be dropped from the final output.

## Usage Example

```bash
# Calculate monthly simple returns, handling missing data by interpolation
python scripts/calculate_returns.py \
  --assets data/processed/classified_assets.csv \
  --prices-dir data/processed/tradeable_prices \
  --method simple \
  --frequency monthly \
  --handle-missing interpolate \
  --output data/processed/returns.csv \
  --summary
```

## Command-Line Arguments

- `--assets`: **(Required)** Path to the classified assets CSV file.
- `--prices-dir`: **(Required)** Directory containing the cleaned price history files.
- `--output`: Path to save the final returns matrix CSV.
- `--method`: The calculation method (`simple`, `log`, `excess`). Default: `simple`.
- `--frequency`: The resampling frequency (`daily`, `weekly`, `monthly`). Default: `daily`.
- `--risk-free-rate`: Annual risk-free rate for `excess` return calculations. Default: `0.0`.
- `--handle-missing`: Strategy for handling gaps (`forward_fill`, `drop`, `interpolate`). Default: `forward_fill`.
- `--max-forward-fill`: The maximum number of consecutive days to fill. Default: `5`.
- `--align-method`: How to align assets with different date ranges (`outer` or `inner`). Default: `outer`.
- `--min-coverage`: The minimum percentage (0.0 to 1.0) of non-null returns required to keep an asset. Default: `0.8`.
- `--business-days`: If specified, reindexes the returns to a business-day calendar.
- `--summary`: If specified, prints a summary of return statistics.
- `--top`: The number of top/bottom assets to show in the summary. Default: `5`.
- `--verbose`: Enable detailed logging output.
